/** @import { MidiControl } from '../../types/internal-types.js' */

export const NAME = "nanoKONTROL2";

export const TRACKS = /** @type {const} */ ([1, 2, 3, 4, 5, 6, 7, 8]);
export const FEATURES = /** @type {const} */ (["KNOB", "SLIDER", "BUTTON"]);

/** @type {Record.<typeof TRACKS[number], number>} */
export const KNOBS = {
  1: 0x10,
  2: 0x11,
  3: 0x12,
  4: 0x13,
  5: 0x14,
  6: 0x15,
  7: 0x16,
  8: 0x17,
};

/** @type {Record.<typeof TRACKS[number], number>} */
export const SLIDERS = {
  1: 0x0,
  2: 0x1,
  3: 0x2,
  4: 0x3,
  5: 0x4,
  6: 0x5,
  7: 0x6,
  8: 0x7,
};

/** @type {Record.<typeof TRACKS[number], { solo: number, mute: number, recArm: number }>} */
export const BUTTONS = {
  1: {
    solo: 0x20,
    mute: 0x30,
    recArm: 0x40,
  },
  2: {
    solo: 0x21,
    mute: 0x31,
    recArm: 0x42,
  },
  3: {
    solo: 0x22,
    mute: 0x32,
    recArm: 0x42,
  },
  4: {
    solo: 0x23,
    mute: 0x33,
    recArm: 0x43,
  },
  5: {
    solo: 0x24,
    mute: 0x34,
    recArm: 0x44,
  },
  6: {
    solo: 0x25,
    mute: 0x35,
    recArm: 0x45,
  },
  7: {
    solo: 0x26,
    mute: 0x36,
    recArm: 0x46,
  },
  8: {
    solo: 0x27,
    mute: 0x37,
    recArm: 0x47,
  },
};

export const GLOBAL_BUTTONS = {
  track: { next: 0x3a, previous: 0x3b },
  marker: { set: 0x3c, next: 0x3d, previous: 0x3e },
  cycle: 0x2e,
  rewind: 0x2b,
  fastForward: 0x2c,
  stop: 0x2a,
  play: 0x29,
  record: 0x2d,
};

export const MESSAGES = {
  button: 0xb0,
  knob: 0xb0,
  slider: 0xb0,
  light: 0xb0,
};

export const VALUES = {
  button: { down: 0x7f, up: 0x0 },
  knob: { high: 0x7f, low: 0x0 },
  slider: { high: 0x7f, low: 0x0 },
};

export const LIGHTS = {
  off: 0x0,
  on: 0x7f,
};

/**
 * @param {MidiControl} controls
 */
export function enableExternalControlOfLEDs(controls) {
  /**
   * This magic string of messages is lifted from
   * https://github.com/overtone/overtone/blob/master/src/overtone/device/midi/nanoKONTROL2.clj#L134-L164
   *
   * It puts the device into External LED Mode, which make the LEDs writable by
   * sending MIDI messages.
   *
   * The fine people at Overtone figured this out by recording the messages sent
   * from the official Korg Kontrol Editor when enabling extrenal LED mode.
   *
   * To reset your device to factory settings:
   * 1) Power it off (aka pull the plug).
   * 2) Hold down Track < and > buttons and Cycle at the same time.
   * 3) While holding buttons down, power it on (aka plug it in)
   * 4) The other buttons blink a few times, after which you can release the
   *    buttons
   *
   * Once the device is in external LED mode, you don't have to do this again.
   *
   * For some weird reason, I have not been able to get this SysEx message to
   * work in Firefox, but it works in node (via node-midi) and in Chrome.
   */
  const MAGIC_SYSEX_MESSAGES = [
    // Device Inquiry Request
    [0xf0, 0x7e, 0x7f, 0x06, 0x01, 0xf7],
    // Native Mode Request (give me current mode data)
    [0xf0, 0x42, 0x40, 0x00, 0x01, 0x13, 0x00, 0x1f, 0x12, 0x00, 0xf7],
    // Device Inquiry Request
    [0xf0, 0x7e, 0x7f, 0x06, 0x01, 0xf7],
    // Writing some stuff
    [
      0xf0, 0x42, 0x40, 0x00, 0x01, 0x13, 0x00, 0x7f, 0x7f, 0x02, 0x03, 0x05, 0x40, 0x00, 0x00,
      0x00, 0x01, 0x10, 0x01, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x10, 0x00, 0x00,
      0x7f, 0x00, 0x01, 0x00, 0x20, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00, 0x30, 0x00, 0x7f, 0x00,
      0x00, 0x01, 0x00, 0x40, 0x00, 0x7f, 0x00, 0x10, 0x00, 0x01, 0x00, 0x01, 0x00, 0x7f, 0x00,
      0x01, 0x00, 0x00, 0x11, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x21, 0x00, 0x7f, 0x00, 0x01,
      0x00, 0x31, 0x00, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x41, 0x00, 0x00, 0x7f, 0x00, 0x10, 0x01,
      0x00, 0x02, 0x00, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x12, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00,
      0x22, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00, 0x32, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x42,
      0x00, 0x7f, 0x00, 0x10, 0x01, 0x00, 0x00, 0x03, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x13,
      0x00, 0x7f, 0x00, 0x01, 0x00, 0x23, 0x00, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x33, 0x00, 0x00,
      0x7f, 0x00, 0x01, 0x00, 0x43, 0x00, 0x7f, 0x00, 0x00, 0x10, 0x01, 0x00, 0x04, 0x00, 0x7f,
      0x00, 0x00, 0x01, 0x00, 0x14, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00, 0x24, 0x00, 0x7f, 0x00,
      0x01, 0x00, 0x00, 0x34, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x44, 0x00, 0x7f, 0x00, 0x10,
      0x01, 0x00, 0x00, 0x05, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x15, 0x00, 0x00, 0x7f, 0x00, 0x01,
      0x00, 0x25, 0x00, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x35, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00,
      0x45, 0x00, 0x7f, 0x00, 0x00, 0x10, 0x01, 0x00, 0x06, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00,
      0x16, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x26, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x36,
      0x00, 0x7f, 0x00, 0x01, 0x00, 0x46, 0x00, 0x00, 0x7f, 0x00, 0x10, 0x01, 0x00, 0x07, 0x00,
      0x00, 0x7f, 0x00, 0x01, 0x00, 0x17, 0x00, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x27, 0x00, 0x7f,
      0x00, 0x00, 0x01, 0x00, 0x37, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00, 0x47, 0x00, 0x7f, 0x00,
      0x10, 0x00, 0x01, 0x00, 0x3a, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x3b, 0x00, 0x7f, 0x00,
      0x01, 0x00, 0x00, 0x2e, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x3c, 0x00, 0x00, 0x7f, 0x00, 0x01,
      0x00, 0x3d, 0x00, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x3e, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00,
      0x2b, 0x00, 0x7f, 0x00, 0x00, 0x01, 0x00, 0x2c, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x2a,
      0x00, 0x7f, 0x00, 0x01, 0x00, 0x00, 0x29, 0x00, 0x7f, 0x00, 0x01, 0x00, 0x2d, 0x00, 0x00,
      0x7f, 0x00, 0x7f, 0x7f, 0x7f, 0x7f, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf7,
    ],
    // Device Inquiry Request
    [0xf0, 0x7e, 0x7f, 0x06, 0x01, 0xf7],
    // Writing some stuff
    [0xf0, 0x42, 0x40, 0x00, 0x01, 0x13, 0x00, 0x1f, 0x11, 0x00, 0xf7],
  ];

  for (let msg of MAGIC_SYSEX_MESSAGES) {
    controls.sendSysEx(msg);
  }
}
